name: 'Automation: Tag issue with package label'

on:
  issues:
    types: [opened]

jobs:
  add_labels:
    name: Add package label
    runs-on: ubuntu-latest
    if: ${{ !github.event.issue.pull_request }}
    steps:
      - name: Get SDK source from issue body
        # https://github.com/actions-ecosystem/action-regex-match
        uses: actions-ecosystem/action-regex-match@v2
        id: sdkSource
        with:
          # Parse SDK source from issue body
          text: ${{ github.event.issue.body }}
          regex: '### Where are you installing the Sentry SDK from\?\n\n(.*)\n\n'

      - name: Map SDK source to Browser label
        # https://github.com/kanga333/variable-mapper
        uses: kanga333/variable-mapper@v0.3.0
        id: browserLabel
        if: steps.sdkSource.outputs.match != ''
        with:
          key: '${{ steps.sdkSource.outputs.group1 }}'
          # Note: Since this is handled as a regex, and JSON parse wrangles slashes /, we just use `.` instead
          map: |
            {
              "Sentry.Browser.Loader": {
                "label": "Browser"
              },
              "Sentry.Browser.CDN.bundle": {
                "label": "Browser"
              }
            }
          export_to: output

      - name: Add Browser label if applicable
        if: steps.browserLabel.outputs.label != ''
        uses: actions-ecosystem/action-add-labels@v1
        with:
          labels: ${{ steps.browserLabel.outputs.label }}

      - name: Map SDK source to delivery method label
        # https://github.com/kanga333/variable-mapper
        uses: kanga333/variable-mapper@v0.3.0
        id: deliveryLabel
        if: steps.sdkSource.outputs.match != ''
        with:
          key: '${{ steps.sdkSource.outputs.group1 }}'
          # Note: Since this is handled as a regex, and JSON parse wrangles slashes /, we just use `.` instead
          map: |
            {
              "Sentry.Browser.Loader": {
                "label": "Loader Script"
              },
              "Sentry.Browser.CDN.bundle": {
                "label": "CDN Bundle"
              }
            }
          export_to: output

      - name: Add delivery method label if applicable
        if: steps.deliveryLabel.outputs.label != ''
        uses: actions-ecosystem/action-add-labels@v1
        with:
          labels: ${{ steps.deliveryLabel.outputs.label }}

      # Scan System Info section for @sentry/* packages (from envinfo output)
      - name: Detect @sentry packages in System Info
        id: packageLabels
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body || '';

            // Extract only the System Info section to avoid matching free-form text
            const systemInfoMatch = body.match(/### System Info\s*\n([\s\S]*?)(?=\n### |\n*$)/);
            if (!systemInfoMatch) {
              console.log('No System Info section found');
              core.setOutput('labels', '');
              return;
            }

            const systemInfoSection = systemInfoMatch[1];
            console.log('Scanning System Info section for @sentry/* packages');

            // Map of package patterns to labels
            const packageToLabel = {
              '@sentry/angular': 'Angular',
              '@sentry/astro': 'Astro',
              '@sentry/aws-serverless': 'AWS Lambda',
              '@sentry/browser': 'Browser',
              '@sentry/bun': 'Bun',
              '@sentry/cloudflare': 'Cloudflare Workers',
              '@sentry/deno': 'Deno',
              '@sentry/ember': 'Ember',
              '@sentry/gatsby': 'Gatsby',
              '@sentry/google-cloud-serverless': 'Google Cloud Functions',
              '@sentry/nestjs': 'Nest.js',
              '@sentry/nextjs': 'Next.js',
              '@sentry/node': 'Node.js',
              '@sentry/nuxt': 'Nuxt',
              '@sentry/react-router': 'React Router Framework',
              '@sentry/react': 'React',
              '@sentry/remix': 'Remix',
              '@sentry/solid': 'Solid',
              '@sentry/solidstart': 'SolidStart',
              '@sentry/svelte': 'Svelte',
              '@sentry/sveltekit': 'SvelteKit',
              '@sentry/tanstackstart-react': 'Tanstack Start React',
              '@sentry/vue': 'Vue',
              '@sentry/wasm': 'WASM',
            };

            const labelsToAdd = new Set();

            // Check for each package in the System Info section
            for (const [pkg, label] of Object.entries(packageToLabel)) {
              // Escape special regex characters in package name
              const escapedPkg = pkg.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
              // Match package name followed by colon (envinfo format) or version pattern
              const regex = new RegExp(escapedPkg + '[:\\s]', 'i');
              if (regex.test(systemInfoSection)) {
                labelsToAdd.add(label);
              }
            }

            const labels = Array.from(labelsToAdd).join('\n');
            console.log('Detected labels:', labels);
            core.setOutput('labels', labels);

      - name: Add package labels if applicable
        if: steps.packageLabels.outputs.labels != ''
        uses: actions-ecosystem/action-add-labels@v1
        with:
          labels: ${{ steps.packageLabels.outputs.labels }}
